<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="http://cdn.babylonjs.com/2-4/babylon.max.js"></script>

    <style>
        #canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
<script>
    window.addEventListener('DOMContentLoaded', function(){
        var canvas = document.getElementById('canvas');
        var elements = [];
        var actions = ['trans', 'rotate', 'shear'];
        var actualAction = actions[0];

        var engine = new BABYLON.Engine(canvas, true);
        engine.enableOfflineSupport = false; // Dont require a manifest file
        var createScene = function(){
            var scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3.White();

            var camera = new BABYLON.ArcRotateCamera(
                "arcCam",
                BABYLON.Tools.ToRadians(90),
                BABYLON.Tools.ToRadians(90),
                20.0,
                BABYLON.Vector3.Zero(),
                scene
            );

            camera.attachControl(canvas,true);
            var light = new BABYLON.PointLight(
                "PointLight",
                new BABYLON.Vector3(0,0,0),
                scene
            );
            
            light.parent = camera;
            light.intensity = 1.5;

            BABYLON.SceneLoader.ImportMesh(
                "","","generic-houses-1.babylon",
                scene,
                function(newMeshes) {
                    newMeshes.forEach(
                        function(mesh) {
                            elements.push(mesh);
                        }
                    );
                }
            );

            console.log(elements);

            scene.registerBeforeRender(function () {

            });

            return scene;
        }

        var scene = createScene();
        var onKeyDown = function(evt) {
            // Key: A - Left
            if (evt.keyCode == 65) {
                if (actualAction === actions[0]) {
                    var transVector = new BABYLON.Vector3(1, 0, 0);
                    translateElements(elements, transVector, transVector);
                }
            
            // Key: D - Right
            } else if (evt.keyCode == 68) {
                if (actualAction === actions[0]) {
                    var transVector = new BABYLON.Vector3(-1, 0, 0);
                    translateElements(elements, transVector, transVector);
                }

            // Key: W - Up
            } else if (evt.keyCode == 87) {
                if (actualAction === actions[0]) {
                    var transVector = new BABYLON.Vector3(0, 0, 1);
                    translateElements(elements, transVector, transVector);
                }

            // Key: S - Down
            } else if (evt.keyCode == 83) {
                if (actualAction === actions[0]) {
                    var transVector = new BABYLON.Vector3(0, 0, -1);
                    translateElements(elements, transVector, transVector);
                }
            
            // Key: I - Translate
            } else if (evt.keyCode == 73) {
                actualAction = actions[0];
            
            // Key: O - Rotate
            } else if (evt.keyCode == 79) {
                actualAction = actions[1];
           
            // Key: P - Shear
            } else if (evt.keyCode == 80) {
                actualAction = actions[2];
            }
        };

        var translateElements = function(elements, houseVector, treeGroundVector) {
                var cont = 1;
                elements.forEach(function(e) {
                    var matrix = BABYLON.Matrix.Translation(0, 0, 0);
                    e.setPivotMatrix(matrix);

                    if (cont === 3 || cont === 4 || cont === 5 || cont === 8) {
                        e.translate(houseVector, 1, BABYLON.Space.LOCAL);
                    }
                    if (cont === 1 || cont === 6 || cont === 7) {
                        e.translate(treeGroundVector, 1.05, BABYLON.Space.LOCAL);
                    }
                    cont++;
                });
        };
        // On key up, reset the movement
        var onKeyUp = function(evt) {
        };

        // Register events with the right Babylon function
        BABYLON.Tools.RegisterTopRootEvents([{
            name: "keydown",
            handler: onKeyDown
        }, {
            name: "keyup",
            handler: onKeyUp
        }]);

        engine.runRenderLoop(function() {
            scene.render();
        });
    });
</script>
</html>
